<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>ndsensor monitor</title>
    <style>
      .sensor {
        display: inline-block;
        margin: 16px 0;
        width: 120px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var http_post = function (where, text_to_send, callback) {
        if (typeof where !== 'string') throw TypeError();
        if (typeof text_to_send !== 'string') throw TypeError();
        if (typeof callback !== 'function') throw TypeError();

        fetch(where, {method: 'POST', body: text_to_send})
          .then(function (response) {
            return response.text();
          })
          .then(function (server_response_text) {
            callback(server_response_text);
          })
          .catch(function (err) {
            callback(null, err);
          });
      };

      var socket = io('http://' + location.host + '/');

      socket.on('view_updated', render);

      var current_view = [];
      function render(new_view) {
        current_view = new_view;
        console.log(JSON.stringify(current_view));
        container.innerHTML = current_view.map(tuple => {
          var name = tuple[0];
          var moni = tuple[1];
          var stat = tuple[2];
          var html = (''
            + '<div class="sensor">'
            +   '<div class="name">'
            +     name
            +   '</div>'
            +   '<div class="moni">'
            +     (moni ? 'monitored' : 'not monitored')
            +   '</div>'
            +   '<div class="stat">'
            +     (stat === 'O' ? 'Good' :
                  stat === 'X' ? 'Bad' :
                  stat === '?' ? 'Not found' :
                  'Unknown Error')
            +   '</div>'
            + '</div>'
          );
          return html;
        }).join('');
      }

      var container = document.getElementById('container');

      container.addEventListener('click', function (evt) {
        var target = evt.target;
        if (target && target.className === 'moni') {
          var name = target.parentNode.childNodes[0].textContent;
          console.log(name, 'clicked!');
          if (target.textContent === 'monitored') {
            http_post('/dismoni', name, ()=>{})
          } else {
            http_post('/moni', name, ()=>{})
          }
        }
      });

    </script>
  </body>
</html>
